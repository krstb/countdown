<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Styling für den datetime-local-Input, um ihn an die anderen Elemente anzupassen */
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex flex-col items-center pt-8 p-4 text-slate-800">
    <div id="countdown-app" class="w-full max-w-sm bg-white rounded-2xl shadow-lg p-4 border border-gray-200">
        <h1 class="text-2xl font-extrabold text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-sky-600">
            Countdown von Robert
        </h1>

        <div class="flex justify-center space-x-2 mb-4">
            <button id="mode-target-date" class="px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 bg-cyan-600 text-white shadow-md">
                Zielzeit
            </button>
            <button id="mode-countdown" class="px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">
                Countdown
            </button>
        </div>

        <div id="input-container" class="min-h-[170px]">
            </div>

        <div class="flex justify-center space-x-2 mb-4">
            <button id="start-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm bg-cyan-600 text-white shadow-md hover:bg-cyan-500 hover:scale-110">
                Start
            </button>
            <button id="reset-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm bg-gray-300 text-gray-500 cursor-not-allowed" disabled>
                Reset
            </button>
            <button id="mute-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm bg-amber-500 text-white shadow-md hover:bg-amber-400 hover:scale-110">
                Ton an
            </button>
            <button id="save-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm bg-blue-500 text-white shadow-md hover:bg-blue-400 hover:scale-110 hidden">
                Speichern
            </button>
        </div>

        <div class="text-center p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
            <p id="target-date-display" class="text-sm text-slate-500 mb-2">Zielzeit: </p>
            <div class="grid grid-cols-5 gap-1 text-center">
                <div><p id="time-days" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Tage</p></div>
                <div><p id="time-hours" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Std</p></div>
                <div><p id="time-minutes" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Min</p></div>
                <div><p id="time-seconds" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Sek</p></div>
                <div><p id="time-milliseconds" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">ms</p></div>
            </div>
        </div>

        <div id="save-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                <h3 id="save-modal-title" class="text-lg font-bold mb-4">Countdown speichern</h3>
                <div id="modal-time-inputs" class="mb-4"></div>
                <input type="text" id="event-name-input" placeholder="Name des Ereignisses" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-save-button" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300">Abbrechen</button>
                    <button id="confirm-save-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-500">Speichern</button>
                </div>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h2 class="text-lg font-bold mb-2">Gespeicherte Countdown-Ereignisse</h2>
            <div id="saved-events-list" class="space-y-2">
                <p class="text-sm text-gray-500">Keine gespeicherten Events.</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM-Elemente abrufen
            const modeTargetDateBtn = document.getElementById('mode-target-date');
            const modeCountdownBtn = document.getElementById('mode-countdown');
            const inputContainer = document.getElementById('input-container');
            const startBtn = document.getElementById('start-button');
            const resetBtn = document.getElementById('reset-button');
            const muteBtn = document.getElementById('mute-button');
            const saveBtn = document.getElementById('save-button');
            const targetDateDisplay = document.getElementById('target-date-display');
            const daysEl = document.getElementById('time-days');
            const hoursEl = document.getElementById('time-hours');
            const minutesEl = document.getElementById('time-minutes');
            const secondsEl = document.getElementById('time-seconds');
            const millisecondsEl = document.getElementById('time-milliseconds');
            const savedEventsList = document.getElementById('saved-events-list');
            const saveModal = document.getElementById('save-modal');
            const saveModalTitle = document.getElementById('save-modal-title');
            const modalTimeInputs = document.getElementById('modal-time-inputs');
            const eventNameInput = document.getElementById('event-name-input');
            const confirmSaveBtn = document.getElementById('confirm-save-button');
            const cancelSaveBtn = document.getElementById('cancel-save-button');

            // App-Zustand
            let mode = 'targetDate';
            let selectedDateTime = '';
            let days = null;
            let hours = null;
            let minutes = null;
            let seconds = null;
            let targetDate = '';
            let isCountingDown = false;
            let isMuted = false;
            let countdownInterval = null;
            let audioContext = null;
            let savedEvents = [];
            let editingEventIndex = null;

            // Hilfsfunktionen
            const padNumber = (num) => String(num).padStart(2, '0');
            const padMilliseconds = (num) => String(Math.floor(num / 10)).padStart(2, '0');

            const setNowAsDateTime = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hour = String(now.getHours()).padStart(2, '0');
                const minute = String(now.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hour}:${minute}`;
            };

            const getFormattedTargetDate = () => {
                if (targetDate) {
                    return new Date(targetDate).toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
                }
                if (selectedDateTime && mode === 'targetDate') {
                    const dateObj = new Date(selectedDateTime);
                    return dateObj.toLocaleString('de-DE', { dateStyle: 'short', timeStyle: 'short' });
                }
                return ''; // Zeigt nichts an, wenn keine Zeit ausgewählt ist
            };

            const playTone = () => {
                if (isMuted) return;
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const allFrequencies = [440, 660, 880, 440, 660, 880, 440, 660, 880];
                const duration = 0.2;
                const delay = 0.1;

                allFrequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.value = 0.5;
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    const startTime = audioContext.currentTime + (index * (duration + delay));
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                });
            };

            const saveAppState = () => {
                const stateToSave = { mode, selectedDateTime, days, hours, minutes, seconds, isCountingDown, isMuted, targetDate };
                try {
                    localStorage.setItem('countdownAppState', JSON.stringify(stateToSave));
                } catch (e) { console.error("Fehler beim Speichern des App-Zustands im localStorage:", e); }
            };

            const saveEvents = () => {
                try {
                    localStorage.setItem('savedCountdownEvents', JSON.stringify(savedEvents));
                } catch (e) { console.error("Fehler beim Speichern der Events im localStorage:", e); }
            };

            const loadState = () => {
                try {
                    const savedAppState = localStorage.getItem('countdownAppState');
                    if (savedAppState) {
                        const data = JSON.parse(savedAppState);
                        mode = data.mode || 'targetDate';
                        isMuted = data.isMuted || false;
                        selectedDateTime = data.selectedDateTime; // Load without default
                        days = data.days;
                        hours = data.hours;
                        minutes = data.minutes;
                        seconds = data.seconds;
                        if (data.isCountingDown && data.targetDate && new Date(data.targetDate).getTime() > new Date().getTime()) {
                            targetDate = data.targetDate;
                            isCountingDown = true;
                            startCountdown(true);
                        }
                    }
                    const savedEventsData = localStorage.getItem('savedCountdownEvents');
                    if (savedEventsData) {
                        savedEvents = JSON.parse(savedEventsData);
                    }
                } catch (e) { console.error("Fehler beim Laden des Zustands aus dem localStorage:", e); }
            };

            const renderSavedEvents = () => {
                savedEventsList.innerHTML = '';
                if (savedEvents.length === 0) {
                    savedEventsList.innerHTML = '<p class="text-sm text-gray-500">Keine gespeicherten Events.</p>';
                    return;
                }
                
                savedEvents.forEach((event, index) => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                    eventEl.innerHTML = `
                        <span class="text-sm font-semibold truncate flex-1 mr-2">${event.name}</span>
                        <div class="flex space-x-1 flex-shrink-0">
                            <button data-index="${index}" class="load-btn px-2 py-1 text-xs font-semibold bg-green-500 text-white rounded-md hover:bg-green-600">Laden</button>
                            <button data-index="${index}" class="edit-btn px-2 py-1 text-xs font-semibold bg-yellow-500 text-white rounded-md hover:bg-yellow-600">Bearbeiten</button>
                            <button data-index="${index}" class="delete-btn px-2 py-1 text-xs font-semibold bg-red-500 text-white rounded-md hover:bg-red-600">Löschen</button>
                        </div>`;
                    savedEventsList.appendChild(eventEl);
                });
            };

            const updateButtonsAndDisplay = () => {
                const isStartable = mode === 'countdown' ? 
                    ((days || 0) > 0 || (hours || 0) > 0 || (minutes || 0) > 0 || (seconds || 0) > 0) :
                    (selectedDateTime && new Date(selectedDateTime).getTime() > new Date().getTime());

                startBtn.disabled = isCountingDown || !isStartable;
                startBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${startBtn.disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-cyan-600 text-white shadow-md hover:bg-cyan-500 hover:scale-110'}`;
                
                resetBtn.disabled = !isCountingDown;
                resetBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${resetBtn.disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-red-500 text-white shadow-md hover:bg-red-400 hover:scale-110'}`;
                
                saveBtn.classList.toggle('hidden', isCountingDown || !isStartable);
                
                muteBtn.textContent = isMuted ? 'Ton an' : 'Ton aus';
                muteBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${isMuted ? 'bg-amber-500 text-white shadow-md hover:bg-amber-400 hover:scale-110' : 'bg-yellow-400 text-white shadow-md hover:bg-yellow-300 hover:scale-110'}`;
                
                targetDateDisplay.textContent = `Zielzeit: ${getFormattedTargetDate()}`;
                saveAppState();
            };
            
            const updateUI = () => {
                modeTargetDateBtn.className = `px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 ${mode === 'targetDate' ? 'bg-cyan-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                modeCountdownBtn.className = `px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 ${mode === 'countdown' ? 'bg-cyan-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                
                const targetDateWrapper = document.getElementById('target-date-wrapper');
                const countdownWrapper = document.getElementById('countdown-wrapper');
                if (mode === 'targetDate') {
                    targetDateWrapper.classList.remove('hidden');
                    countdownWrapper.classList.add('hidden');
                } else {
                    targetDateWrapper.classList.add('hidden');
                    countdownWrapper.classList.remove('hidden');
                }

                updateButtonsAndDisplay();
                renderSavedEvents();
            };
            
            const createAndAttachInputs = () => {
                const targetDateWrapper = document.createElement('div');
                targetDateWrapper.id = 'target-date-wrapper';
                targetDateWrapper.innerHTML = `
                    <div class="flex flex-col gap-4 w-full mb-4">
                        <div>
                            <label for="target-date-preset-select" class="block text-xs font-medium text-slate-500 mb-1">Voreinstellungen</label>
                            <select id="target-date-preset-select" class="w-full px-3 py-2 bg-gray-100 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm appearance-none cursor-pointer">
                                <option value="" disabled selected hidden>Voreinstellung wählen</option>
                                <option value="fussball-abfahrt">Fussball Abfahrt</option>
                                <option value="now">Aktuelle Zeit</option>
                                <option value="next-9am">Nächster 9.00 Uhr</option>
                                <option value="tomorrow-9am">Morgen um 9.00 Uhr</option>
                                <option value="jan-1-next-year">Nächster 01.01.</option>
                                <option value="next-march-27">Nächster 27.03.</option>
                            </select>
                        </div>
                        <div>
                            <label for="datetime-input" class="block text-xs font-medium text-slate-500 mb-1">Manuell eingeben</label>
                            <input type="datetime-local" id="datetime-input" class="w-full px-3 py-2 bg-gray-100 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm text-center">
                        </div>
                    </div>`;
                
                const countdownWrapper = document.createElement('div');
                countdownWrapper.id = 'countdown-wrapper';
                countdownWrapper.innerHTML = `
                    <div class="flex flex-col gap-4 w-full mb-4">
                        <div>
                            <label for="countdown-preset-select" class="block text-xs font-medium text-slate-500 mb-1">Voreinstellungen</label>
                            <select id="countdown-preset-select" class="w-full px-3 py-2 bg-gray-100 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm appearance-none cursor-pointer">
                                <option value="" disabled selected hidden>Voreinstellung wählen</option>
                                <option value="0:0:10">10 Sek</option><option value="0:1:0">1 Min</option><option value="0:5:0">5 Min</option><option value="0:10:0">10 Min</option><option value="0:15:0">15 Min</option><option value="0:30:0">30 Min</option><option value="0:45:0">45 Min</option><option value="1:0:0">60 Min</option><option value="2:0:0">2 Std</option><option value="10:0:0">10 Std</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Manuell eingeben</label>
                            <div class="flex justify-center space-x-2">
                                ${['days:Tage', 'hours:Std', 'minutes:Min', 'seconds:Sek'].map(field => {
                                    const [key, label] = field.split(':');
                                    return `<div class="flex flex-col items-center">
                                        <input type="number" id="input-${key}" class="w-10 text-center px-1 py-2 bg-gray-100 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500 text-sm" min="0" />
                                        <span class="mt-1 text-xs text-slate-500">${label}</span>
                                    </div>`
                                }).join('')}
                            </div>
                        </div>
                    </div>`;

                inputContainer.appendChild(targetDateWrapper);
                inputContainer.appendChild(countdownWrapper);

                // Attach Listeners
                targetDateWrapper.querySelector('#datetime-input').addEventListener('input', (e) => {
                    selectedDateTime = e.target.value;
                    updateButtonsAndDisplay();
                });
                targetDateWrapper.querySelector('#target-date-preset-select').addEventListener('change', (e) => handleTargetDatePresetChange(e.target.value));

                ['days', 'hours', 'minutes', 'seconds'].forEach(key => {
                    countdownWrapper.querySelector(`#input-${key}`).addEventListener('input', (e) => {
                        const value = e.target.value === '' ? null : Math.max(0, parseInt(e.target.value));
                        switch (key) {
                            case 'days': days = value; break;
                            case 'hours': hours = value; break;
                            case 'minutes': minutes = value; break;
                            case 'seconds': seconds = value; break;
                        }
                        updateButtonsAndDisplay();
                    });
                });
                countdownWrapper.querySelector('#countdown-preset-select').addEventListener('change', (e) => handleCountdownPresetChange(e.target.value));

                // Set initial values from state
                targetDateWrapper.querySelector('#datetime-input').value = selectedDateTime;
                countdownWrapper.querySelector('#input-days').value = days ?? '';
                countdownWrapper.querySelector('#input-hours').value = hours ?? '';
                countdownWrapper.querySelector('#input-minutes').value = minutes ?? '';
                countdownWrapper.querySelector('#input-seconds').value = seconds ?? '';
            };

            const startCountdown = (isReload = false) => {
                if (isCountingDown && !isReload) return;
                clearInterval(countdownInterval);
                
                if (!isReload) {
                    if (mode === 'countdown') {
                        const totalMilliseconds = ((days || 0) * 86400000) + ((hours || 0) * 3600000) + ((minutes || 0) * 60000) + ((seconds || 0) * 1000);
                        if (totalMilliseconds === 0) return;
                        targetDate = new Date(new Date().getTime() + totalMilliseconds).toISOString();
                    } else {
                        if (!selectedDateTime) return;
                        targetDate = new Date(selectedDateTime).toISOString();
                    }
                }
                
                isCountingDown = true;
                
                const tick = () => {
                    const difference = new Date(targetDate).getTime() - new Date().getTime();
                    if (difference <= 0) {
                        clearInterval(countdownInterval);
                        isCountingDown = false;
                        // Die Zeile, die die Zielzeit gelöscht hat, wurde entfernt.
                        daysEl.textContent = '00';
                        hoursEl.textContent = '00';
                        minutesEl.textContent = '00';
                        secondsEl.textContent = '00';
                        millisecondsEl.textContent = '00';
                        playTone();
                        updateUI();
                        return;
                    }
                    daysEl.textContent = padNumber(Math.floor(difference / 86400000));
                    hoursEl.textContent = padNumber(Math.floor((difference % 86400000) / 3600000));
                    minutesEl.textContent = padNumber(Math.floor((difference % 3600000) / 60000));
                    secondsEl.textContent = padNumber(Math.floor((difference % 60000) / 1000));
                    millisecondsEl.textContent = padMilliseconds(difference % 1000);
                };
                
                countdownInterval = setInterval(tick, 10);
                tick();
                updateUI();
            };

            const stopCountdown = () => {
                clearInterval(countdownInterval);
                isCountingDown = false;
                targetDate = '';
                daysEl.textContent = '00';
                hoursEl.textContent = '00';
                minutesEl.textContent = '00';
                secondsEl.textContent = '00';
                millisecondsEl.textContent = '00';
                updateUI();
            };

            // --- Event Listeners ---

            modeTargetDateBtn.addEventListener('click', () => {
                if (mode === 'targetDate') return;
                mode = 'targetDate';
                if (!document.getElementById('datetime-input').value) {
                    selectedDateTime = setNowAsDateTime();
                    document.getElementById('datetime-input').value = selectedDateTime;
                }
                updateUI();
            });

            modeCountdownBtn.addEventListener('click', () => {
                if (mode === 'countdown') return;
                mode = 'countdown';
                // Stellt sicher, dass die manuellen Eingabefelder immer die korrekten Werte aus dem Zustand anzeigen
                document.getElementById('input-days').value = days ?? '';
                document.getElementById('input-hours').value = hours ?? '';
                document.getElementById('input-minutes').value = minutes ?? '';
                document.getElementById('input-seconds').value = seconds ?? '';
                updateUI();
            });

            startBtn.addEventListener('click', () => startCountdown(false));
            resetBtn.addEventListener('click', stopCountdown);

            muteBtn.addEventListener('click', () => {
                isMuted = !isMuted;
                updateUI();
            });
            
            saveBtn.addEventListener('click', () => {
                editingEventIndex = null;
                modalTimeInputs.innerHTML = ''; 
                saveModalTitle.textContent = 'Countdown speichern';
                confirmSaveBtn.textContent = 'Speichern';
                eventNameInput.value = '';
                saveModal.classList.remove('hidden');
                eventNameInput.focus();
            });

            const closeModal = () => {
                modalTimeInputs.innerHTML = '';
                saveModal.classList.add('hidden');
                editingEventIndex = null;
            };

            cancelSaveBtn.addEventListener('click', closeModal);

            confirmSaveBtn.addEventListener('click', () => {
                const eventName = eventNameInput.value.trim();
                if (eventName) {
                    let eventData;
                    if (editingEventIndex !== null) {
                        const originalEvent = savedEvents[editingEventIndex];
                        eventData = { ...originalEvent, name: eventName }; 
                        if (originalEvent.mode === 'targetDate') {
                            eventData.selectedDateTime = document.getElementById('modal-datetime-input').value;
                        } else {
                            eventData.days = parseInt(document.getElementById('modal-input-days').value) || null;
                            eventData.hours = parseInt(document.getElementById('modal-input-hours').value) || null;
                            eventData.minutes = parseInt(document.getElementById('modal-input-minutes').value) || null;
                            eventData.seconds = parseInt(document.getElementById('modal-input-seconds').value) || null;
                        }
                        savedEvents[editingEventIndex] = eventData;
                    } else {
                        eventData = {
                            name: eventName,
                            mode: mode,
                            selectedDateTime: mode === 'targetDate' ? selectedDateTime : null,
                            days: mode === 'countdown' ? days : null,
                            hours: mode === 'countdown' ? hours : null,
                            minutes: mode === 'countdown' ? minutes : null,
                            seconds: mode === 'countdown' ? seconds : null,
                        };
                        savedEvents.push(eventData);
                    }
                    saveEvents();
                    closeModal();
                    updateUI();
                }
            });

            savedEventsList.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target || !target.dataset.index) return;
                const index = parseInt(target.dataset.index);
                const event = savedEvents[index];
                if (!event) return;

                if (target.classList.contains('load-btn')) {
                    mode = event.mode;
                    selectedDateTime = event.selectedDateTime;
                    days = event.days; 
                    hours = event.hours; 
                    minutes = event.minutes; 
                    seconds = event.seconds;
                    
                    document.getElementById('datetime-input').value = selectedDateTime;
                    document.getElementById('input-days').value = days ?? '';
                    document.getElementById('input-hours').value = hours ?? '';
                    document.getElementById('input-minutes').value = minutes ?? '';
                    document.getElementById('input-seconds').value = seconds ?? '';
                    
                    updateUI();
                } else if (target.classList.contains('edit-btn')) {
                    editingEventIndex = index;
                    if (event.mode === 'targetDate') {
                        modalTimeInputs.innerHTML = `
                            <label for="modal-datetime-input" class="block text-xs font-medium text-slate-500 mb-1">Neue Zielzeit</label>
                            <input type="datetime-local" id="modal-datetime-input" value="${event.selectedDateTime || ''}" class="w-full px-3 py-2 bg-gray-100 rounded-lg border border-gray-300 text-sm text-center">
                        `;
                    } else {
                         modalTimeInputs.innerHTML = `
                            <label class="block text-xs font-medium text-slate-500 mb-1">Neue Countdown-Zeit</label>
                            <div class="flex justify-center space-x-0.5">
                                ${['days:Tage', 'hours:Std', 'minutes:Min', 'seconds:Sek'].map(field => {
                                    const [key, label] = field.split(':');
                                    return `<div class="flex flex-col items-center">
                                        <input type="number" id="modal-input-${key}" value="${event[key] ?? ''}" class="w-10 text-center px-1 py-2 bg-gray-100 rounded-lg border border-gray-300 text-sm" min="0" />
                                        <span class="mt-1 text-xs text-slate-500">${label}</span>
                                    </div>`
                                }).join('')}
                            </div>
                        `;
                    }
                    saveModalTitle.textContent = 'Ereignis bearbeiten';
                    confirmSaveBtn.textContent = 'Aktualisieren';
                    eventNameInput.value = event.name;
                    saveModal.classList.remove('hidden');
                    eventNameInput.focus();
                } else if (target.classList.contains('delete-btn')) {
                    savedEvents.splice(index, 1);
                    saveEvents();
                    updateUI();
                }
            });
            
            const handleCountdownPresetChange = (value) => {
                const [h, m, s] = value.split(':').map(Number);
                days = 0; hours = h; minutes = m; seconds = s;
                document.getElementById('input-days').value = days;
                document.getElementById('input-hours').value = hours;
                document.getElementById('input-minutes').value = minutes;
                document.getElementById('input-seconds').value = seconds;
                updateUI();
                document.getElementById('countdown-preset-select').selectedIndex = 0;
            };

            const handleTargetDatePresetChange = (value) => {
                if (value === 'now') {
                    selectedDateTime = setNowAsDateTime();
                    document.getElementById('datetime-input').value = selectedDateTime;
                    updateUI();
                    document.getElementById('target-date-preset-select').selectedIndex = 0;
                    return;
                }

                let newDate = new Date();
                switch (value) {
                    case 'fussball-abfahrt':
                        newDate.setHours(14, 0, 0, 0);
                        break;
                    case 'next-9am':
                        newDate.setHours(9, 0, 0, 0);
                        if (newDate.getTime() <= new Date().getTime()) newDate.setDate(newDate.getDate() + 1);
                        break;
                    case 'tomorrow-9am':
                        newDate.setDate(newDate.getDate() + 1);
                        newDate.setHours(9, 0, 0, 0);
                        break;
                    case 'jan-1-next-year':
                        newDate.setMonth(0, 1);
                        newDate.setHours(0, 0, 0, 0);
                        if (newDate.getTime() <= new Date().getTime()) newDate.setFullYear(newDate.getFullYear() + 1);
                        break;
                    case 'next-march-27':
                        const targetMonth = 2, targetDay = 27;
                        if (newDate.getMonth() > targetMonth || (newDate.getMonth() === targetMonth && newDate.getDate() >= targetDay)) {
                            newDate.setFullYear(newDate.getFullYear() + 1);
                        }
                        newDate.setMonth(targetMonth, targetDay);
                        newDate.setHours(0, 0, 0, 0);
                        break;
                }
                selectedDateTime = `${newDate.getFullYear()}-${String(newDate.getMonth() + 1).padStart(2, '0')}-${String(newDate.getDate()).padStart(2, '0')}T${String(newDate.getHours()).padStart(2, '0')}:${String(newDate.getMinutes()).padStart(2, '0')}`;
                document.getElementById('datetime-input').value = selectedDateTime;
                updateUI();
                document.getElementById('target-date-preset-select').selectedIndex = 0;
            };
            
            // Initialisierung
            loadState();
            if (!selectedDateTime) {
                selectedDateTime = setNowAsDateTime();
            }
            createAndAttachInputs();
            updateUI();
            if (!isCountingDown) {
                // Initial display auf 00 setzen
                 daysEl.textContent = '00';
                 hoursEl.textContent = '00';
                 minutesEl.textContent = '00';
                 secondsEl.textContent = '00';
                 millisecondsEl.textContent = '00';
            }
        });
    </script>
</body>
</html>