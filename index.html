<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png"> 
    <link rel="icon" type="image/x-icon" href="favicon.svg">
    <meta name="theme-color" content="#000000">
    <meta name="color-scheme" content="light">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="icon-192.png">
 
    <script>
      // Service Worker Registrierung
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js')
            .catch(err => console.log('SW Fehler:', err));
        });
      }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>

        /* Fix für PWA-Ränder */
    html {background-color: #000000 !important;}
        
        body {background-color: #C3EBFF; font-family: 'Inter', sans-serif; }
        input[type="datetime-local"]::-webkit-calendar-picker-indicator { cursor: pointer; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-8 p-4 text-slate-800">
    
    <div id="countdown-app" class="w-full max-w-sm bg-white rounded-2xl shadow-lg p-4 border border-gray-200">
        <h1 id="main-title" class="text-2xl font-extrabold text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-sky-600">
            Countdown
        </h1>

        <div class="flex justify-center space-x-2 mb-4">
            <button id="mode-target-date" class="px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300">Zielzeit</button>
            <button id="mode-countdown" class="px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300">Countdown</button>
        </div>

        <div id="input-container" class="min-h-[170px]"></div>

        <div class="flex justify-center space-x-2 mb-4">
            <button id="start-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm">Start</button>
            <button id="reset-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm">Reset</button>
            <button id="mute-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm">Ton an</button>
            <button id="save-button" class="px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm bg-blue-500 text-white shadow-md hover:bg-blue-400 hover:scale-110 hidden">Speichern</button>
        </div>

        <div class="text-center p-4 bg-gray-50 rounded-xl shadow-inner border border-gray-200">
            <p id="target-date-display" class="text-sm text-slate-500 mb-2">Zielzeit: </p>
            <div class="grid grid-cols-5 gap-1 text-center">
                <div><p id="time-days" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Tage</p></div>
                <div><p id="time-hours" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Std</p></div>
                <div><p id="time-minutes" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Min</p></div>
                <div><p id="time-seconds" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">Sek</p></div>
                <div><p id="time-milliseconds" class="text-xl font-extrabold text-cyan-600 font-mono">00</p><p class="text-xs text-slate-500">ms</p></div>
            </div>
        </div>

        <div id="save-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                <h3 id="save-modal-title" class="text-lg font-bold mb-4">Countdown speichern</h3>
                <div id="modal-time-inputs" class="mb-4"></div>
                <input type="text" id="event-name-input" placeholder="Name des Ereignisses" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="flex justify-end space-x-2">
                    <button id="cancel-save-button" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300">Abbrechen</button>
                    <button id="confirm-save-button" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-full hover:bg-blue-500">Speichern</button>
                </div>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-white rounded-2xl shadow-lg border border-gray-200">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-bold">gespeichert</h2>
                <div class="flex space-x-1">
                    <button id="export-csv-btn" title="Export CSV" class="p-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors border border-slate-300 text-slate-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                    <button id="import-csv-btn" title="Import CSV" class="p-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors border border-slate-300 text-slate-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    </button>
                    <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                </div>
            </div>
            <div id="saved-events-list" class="space-y-2 max-h-32 overflow-y-auto pr-1">
                <p class="text-sm text-gray-500">nichts gespeicherten</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modeTargetDateBtn = document.getElementById('mode-target-date');
            const modeCountdownBtn = document.getElementById('mode-countdown');
            const inputContainer = document.getElementById('input-container');
            const startBtn = document.getElementById('start-button');
            const resetBtn = document.getElementById('reset-button');
            const muteBtn = document.getElementById('mute-button');
            const saveBtn = document.getElementById('save-button');
            const targetDateDisplay = document.getElementById('target-date-display');
            const daysEl = document.getElementById('time-days');
            const hoursEl = document.getElementById('time-hours');
            const minutesEl = document.getElementById('time-minutes');
            const secondsEl = document.getElementById('time-seconds');
            const millisecondsEl = document.getElementById('time-milliseconds');
            const savedEventsList = document.getElementById('saved-events-list');
            const saveModal = document.getElementById('save-modal');
            const modalTimeInputs = document.getElementById('modal-time-inputs');
            const eventNameInput = document.getElementById('event-name-input');
            const confirmSaveBtn = document.getElementById('confirm-save-button');
            const cancelSaveBtn = document.getElementById('cancel-save-button');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const csvFileInput = document.getElementById('csv-file-input');
            const mainTitle = document.getElementById('main-title');

            let mode = 'targetDate';
            let selectedDateTime = '';
            let days = null, hours = null, minutes = null, seconds = null;
            let targetDate = '';
            let isCountingDown = false;
            let isMuted = false;
            let countdownInterval = null;
            let audioContext = null;
            let savedEvents = [];
            let editingEventIndex = null;
            let currentTitle = '';
            let pendingTitle = ''; 
            let hasManualChanges = false;

            const padNumber = (num) => String(num).padStart(2, '0');
            const padMilliseconds = (num) => String(Math.floor(num / 10)).padStart(2, '0');
            const formatInputVal = (val) => (val === 0 || val === null) ? '' : val;

            const setNowAsDateTime = () => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            };

            const clearTitles = () => {
                currentTitle = '';
                pendingTitle = '';
            };

            const saveEventsToStorage = () => {
                localStorage.setItem('savedCountdownEvents', JSON.stringify(savedEvents));
            };

            const renderSavedEvents = () => {
                savedEventsList.innerHTML = '';
                savedEvents.sort((a, b) => a.name.localeCompare(b.name, 'de', { sensitivity: 'base' }));

                if (savedEvents.length === 0) {
                    savedEventsList.innerHTML = '<p class="text-sm text-gray-500">Keine gespeicherten Events.</p>';
                    return;
                }
                
                savedEvents.forEach((event, index) => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg border border-gray-200';
                    eventEl.innerHTML = `
                        <span class="text-sm font-semibold truncate flex-1 mr-2">${event.name}</span>
                        <div class="flex space-x-1 flex-shrink-0">
                            <button data-index="${index}" class="load-btn px-2 py-1 text-xs font-semibold bg-green-500 text-white rounded-md hover:bg-green-600 transition-all">Laden</button>
                            <button data-index="${index}" class="edit-btn px-2 py-1 text-xs font-semibold bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-all">Edit</button>
                            <button data-index="${index}" class="delete-btn px-2 py-1 text-xs font-semibold bg-red-500 text-white rounded-md hover:bg-red-600 transition-all">Löschen</button>
                        </div>`;
                    savedEventsList.appendChild(eventEl);
                });
            };

            const updateButtonsAndDisplay = () => {
                const isStartable = mode === 'countdown' ? 
                    ((days || 0) > 0 || (hours || 0) > 0 || (minutes || 0) > 0 || (seconds || 0) > 0) :
                    (selectedDateTime && new Date(selectedDateTime).getTime() > new Date().getTime());

                startBtn.disabled = isCountingDown || !isStartable;
                startBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${startBtn.disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-cyan-600 text-white shadow-md hover:bg-cyan-500 hover:scale-110'}`;
                resetBtn.disabled = !isCountingDown;
                resetBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${resetBtn.disabled ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-red-500 text-white shadow-md hover:bg-red-400 hover:scale-110'}`;
                saveBtn.classList.toggle('hidden', isCountingDown || !isStartable);
                muteBtn.className = `px-3 py-1 rounded-full font-bold transition-all duration-300 transform text-sm ${isMuted ? 'bg-amber-500 text-white shadow-md hover:bg-amber-400' : 'bg-yellow-400 text-white shadow-md hover:bg-yellow-300'}`;
                muteBtn.textContent = isMuted ? 'Ton an' : 'Ton aus';
                targetDateDisplay.textContent = `Zielzeit: ${targetDate ? new Date(targetDate).toLocaleString() : (selectedDateTime && mode === 'targetDate' ? new Date(selectedDateTime).toLocaleString() : '-')}`;
                
                mainTitle.textContent = currentTitle ? `Countdown ${currentTitle}` : 'Countdown';

                const state = { mode, selectedDateTime, days, hours, minutes, seconds, isMuted, isCountingDown, targetDate, currentTitle, pendingTitle, hasManualChanges };
                localStorage.setItem('countdownAppState', JSON.stringify(state));
            };

            const updateUI = () => {
                modeTargetDateBtn.className = `px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 ${mode === 'targetDate' ? 'bg-cyan-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                modeCountdownBtn.className = `px-3 py-1 rounded-full text-xs font-semibold transition-all duration-300 ${mode === 'countdown' ? 'bg-cyan-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`;
                document.getElementById('target-date-wrapper').classList.toggle('hidden', mode !== 'targetDate');
                document.getElementById('countdown-wrapper').classList.toggle('hidden', mode !== 'countdown');
                updateButtonsAndDisplay();
                renderSavedEvents();
            };

            const createInputs = () => {
                inputContainer.innerHTML = `
                    <div id="target-date-wrapper" class="flex flex-col gap-4 w-full mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Voreinstellungen</label>
                            <select id="target-date-preset-select" class="w-full px-3 py-2 bg-gray-100 rounded-xl border text-sm cursor-pointer appearance-none">
                                <option value="" disabled selected hidden>Voreinstellung wählen</option>
                                <option value="fussball-abfahrt">Fussball Abfahrt</option>
                                <option value="now">Aktuelle Zeit</option>
                                <option value="next-9am">Nächster 9.00 Uhr</option>
                                <option value="tomorrow-9am">Morgen um 9.00 Uhr</option>
                                <option value="jan-1-next-year">Nächster 01.01.</option>
                                <option value="next-march-27">Nächster 27.03.</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Manuell eingeben</label>
                            <input type="datetime-local" id="datetime-input" class="w-full px-3 py-2 bg-gray-100 rounded-xl border text-sm text-center">
                        </div>
                    </div>
                    <div id="countdown-wrapper" class="hidden flex flex-col gap-4 w-full mb-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Voreinstellungen</label>
                            <select id="countdown-preset-select" class="w-full px-3 py-2 bg-gray-100 rounded-xl border text-sm cursor-pointer appearance-none">
                                <option value="" disabled selected hidden>Voreinstellung wählen</option>
                                <option value="0:0:10">10 Sek</option><option value="0:1:0">1 Min</option><option value="0:5:0">5 Min</option><option value="0:10:0">10 Min</option><option value="0:15:0">15 Min</option><option value="0:30:0">30 Min</option><option value="0:45:0">45 Min</option><option value="1:0:0">60 Min</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">Manuell eingeben</label>
                            <div class="flex justify-center space-x-2">
                                ${['days:Tage', 'hours:Std', 'minutes:Min', 'seconds:Sek'].map(f => {
                                    const [k, l] = f.split(':');
                                    return `<div class="flex flex-col items-center">
                                        <input type="number" id="input-${k}" class="w-10 text-center px-1 py-2 bg-gray-100 rounded-xl border text-sm" min="0">
                                        <span class="mt-1 text-xs text-slate-500">${l}</span>
                                    </div>`
                                }).join('')}
                            </div>
                        </div>
                    </div>`;

                document.getElementById('datetime-input').addEventListener('input', (e) => { 
                    selectedDateTime = e.target.value; 
                    hasManualChanges = true;
                    pendingTitle = ''; // Bei manueller Änderung wird der pendingTitle gelöscht
                    updateButtonsAndDisplay(); 
                });
                document.getElementById('target-date-preset-select').addEventListener('change', (e) => { 
                    handleTargetDatePreset(e.target.value); 
                    hasManualChanges = true;
                    pendingTitle = '';
                });
                document.getElementById('countdown-preset-select').addEventListener('change', (e) => { 
                    handleCountdownPreset(e.target.value); 
                    hasManualChanges = true;
                    pendingTitle = '';
                });
                ['days', 'hours', 'minutes', 'seconds'].forEach(k => {
                    const el = document.getElementById(`input-${k}`);
                    if(el) {
                        el.addEventListener('input', (e) => {
                            const val = e.target.value === '' ? null : Math.max(0, parseInt(e.target.value));
                            if(k === 'days') days = val; if(k === 'hours') hours = val; if(k === 'minutes') minutes = val; if(k === 'seconds') seconds = val;
                            hasManualChanges = true;
                            pendingTitle = ''; // Bei manueller Änderung wird der pendingTitle gelöscht
                            updateButtonsAndDisplay();
                        });
                    }
                });
            };

            const handleTargetDatePreset = (val) => {
                let d = new Date();
                if (val === 'now') d = new Date();
                else if (val === 'fussball-abfahrt') d.setHours(14,0,0,0);
                else if (val === 'next-9am') { d.setHours(9,0,0,0); if(d < new Date()) d.setDate(d.getDate()+1); }
                else if (val === 'tomorrow-9am') { d.setDate(d.getDate()+1); d.setHours(9,0,0,0); }
                else if (val === 'jan-1-next-year') { d.setFullYear(d.getFullYear()+(d.getMonth()===0&&d.getDate()===1?0:1),0,1); d.setHours(0,0,0,0); }
                else if (val === 'next-march-27') { d.setFullYear(d.getFullYear()+(d.getMonth()>2||(d.getMonth()===2&&d.getDate()>=27)?1:0),2,27); d.setHours(0,0,0,0); }
                selectedDateTime = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                document.getElementById('datetime-input').value = selectedDateTime;
                updateUI();
                document.getElementById('target-date-preset-select').selectedIndex = 0;
            };

            const handleCountdownPreset = (val) => {
                const [h, m, s] = val.split(':').map(Number);
                days = 0; hours = h; minutes = m; seconds = s;
                document.getElementById('input-days').value = '';
                document.getElementById('input-hours').value = formatInputVal(h);
                document.getElementById('input-minutes').value = formatInputVal(m);
                document.getElementById('input-seconds').value = formatInputVal(s);
                updateUI();
                document.getElementById('countdown-preset-select').selectedIndex = 0;
            };

            const startCountdown = (reload = false) => {
                if (isCountingDown && !reload) return;
                clearInterval(countdownInterval);
                if (!reload) {
                    if (mode === 'countdown') {
                        const ms = ((days||0)*86400000) + ((hours||0)*3600000) + ((minutes||0)*60000) + ((seconds||0)*1000);
                        targetDate = new Date(Date.now() + ms).toISOString();
                    } else {
                        targetDate = new Date(selectedDateTime).toISOString();
                    }
                    
                    // Titel-Logik: Nur beim Starten wird der Titel gesetzt.
                    // Wenn keine manuellen Änderungen vorlagen und ein pendingTitle existiert, wird dieser übernommen.
                    // Ansonsten (bei manuellen Änderungen oder leerem Speicher) wird blanko geschrieben.
                    if (!hasManualChanges && pendingTitle) {
                        currentTitle = pendingTitle;
                    } else {
                        currentTitle = '';
                    }
                }
                isCountingDown = true;
                countdownInterval = setInterval(() => {
                    const diff = new Date(targetDate).getTime() - Date.now();
                    if (diff <= 0) {
                        clearInterval(countdownInterval);
                        isCountingDown = false;
                        if(!isMuted) playTone();
                        updateUI();
                        return;
                    }
                    daysEl.textContent = padNumber(Math.floor(diff / 86400000));
                    hoursEl.textContent = padNumber(Math.floor((diff % 86400000) / 3600000));
                    minutesEl.textContent = padNumber(Math.floor((diff % 3600000) / 60000));
                    secondsEl.textContent = padNumber(Math.floor((diff % 60000) / 1000));
                    millisecondsEl.textContent = padMilliseconds(diff % 1000);
                }, 10);
                updateUI();
            };

            const playTone = () => {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const frequencies = [440, 660, 880, 440, 660, 880, 440, 660, 880];
                const duration = 0.2;
                const delay = 0.1;

                frequencies.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    const startTime = audioContext.currentTime + (index * (duration + delay));
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                });
            };

            exportCsvBtn.addEventListener('click', () => {
                const header = "Name,Mode,DateTime,Days,Hours,Minutes,Seconds\n";
                const rows = savedEvents.map(e => `"${e.name}",${e.mode},${e.selectedDateTime||''},${e.days||0},${e.hours||0},${e.minutes||0},${e.seconds||0}`).join('\n');
                const blob = new Blob([header + rows], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = 'countdown_liste.csv'; a.click();
            });

            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', (e) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n').slice(1);
                    lines.forEach(line => {
                        const p = line.match(/(".*?"|[^,]+|(?<=,)(?=,)|(?<=,)$)/g);
                        if (p && p.length >= 7) {
                            const name = p[0].replace(/"/g, '').trim();
                            if (!savedEvents.some(se => se.name === name)) {
                                savedEvents.push({
                                    name, mode: p[1].trim(), selectedDateTime: p[2].trim() || null,
                                    days: parseInt(p[3]) || 0, hours: parseInt(p[4]) || 0,
                                    minutes: parseInt(p[5]) || 0, seconds: parseInt(p[6]) || 0
                                });
                            }
                        }
                    });
                    saveEventsToStorage(); renderSavedEvents(); updateUI();
                };
                reader.readAsText(e.target.files[0]);
            });

            modeTargetDateBtn.addEventListener('click', () => { mode = 'targetDate'; updateUI(); });
            modeCountdownBtn.addEventListener('click', () => { mode = 'countdown'; updateUI(); });
            startBtn.addEventListener('click', () => startCountdown());
            
            resetBtn.addEventListener('click', () => { 
                clearInterval(countdownInterval); 
                isCountingDown = false; 
                targetDate = ''; 
                // Reset Taste ändert die Überschrift nicht (currentTitle bleibt), 
                // aber bereitet das System auf neue Eingaben vor.
                updateUI(); 
            });

            muteBtn.addEventListener('click', () => { isMuted = !isMuted; updateUI(); });
            
            saveBtn.addEventListener('click', () => {
                editingEventIndex = null;
                eventNameInput.value = '';
                if (mode === 'targetDate') {
                    modalTimeInputs.innerHTML = `<label class="block text-xs font-medium text-slate-500 mb-1">Zielzeit</label>
                    <input type="datetime-local" id="modal-datetime-input" class="w-full p-2 border border-gray-200 rounded-lg mb-2" value="${selectedDateTime}">`;
                } else {
                    modalTimeInputs.innerHTML = `<label class="block text-xs font-medium text-slate-500 mb-1">Dauer (T:H:M:S)</label>
                    <div class="flex space-x-1 mb-2">
                        <input type="number" id="modal-input-days" class="w-1/4 p-1 border rounded" placeholder="T" value="${formatInputVal(days)}">
                        <input type="number" id="modal-input-hours" class="w-1/4 p-1 border rounded" placeholder="H" value="${formatInputVal(hours)}">
                        <input type="number" id="modal-input-minutes" class="w-1/4 p-1 border rounded" placeholder="M" value="${formatInputVal(minutes)}">
                        <input type="number" id="modal-input-seconds" class="w-1/4 p-1 border rounded" placeholder="S" value="${formatInputVal(seconds)}">
                    </div>`;
                }
                saveModal.classList.remove('hidden');
            });

            confirmSaveBtn.addEventListener('click', () => {
                const name = eventNameInput.value.trim();
                if (!name) return;

                let data;
                if (editingEventIndex !== null) {
                    const evMode = savedEvents[editingEventIndex].mode;
                    if (evMode === 'targetDate') {
                        data = { 
                            name, 
                            mode: evMode, 
                            selectedDateTime: document.getElementById('modal-datetime-input').value, 
                            days: null, hours: null, minutes: null, seconds: null 
                        };
                    } else {
                        data = { 
                            name, 
                            mode: evMode, 
                            selectedDateTime: null, 
                            days: parseInt(document.getElementById('modal-input-days').value) || 0,
                            hours: parseInt(document.getElementById('modal-input-hours').value) || 0,
                            minutes: parseInt(document.getElementById('modal-input-minutes').value) || 0,
                            seconds: parseInt(document.getElementById('modal-input-seconds').value) || 0
                        };
                    }
                    savedEvents[editingEventIndex] = data;
                } else {
                    data = { name, mode, selectedDateTime: mode === 'targetDate' ? selectedDateTime : null, days, hours, minutes, seconds };
                    savedEvents.push(data);
                }
                saveEventsToStorage(); saveModal.classList.add('hidden'); updateUI();
            });

            cancelSaveBtn.addEventListener('click', () => saveModal.classList.add('hidden'));

            savedEventsList.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const idx = parseInt(btn.dataset.index);
                const ev = savedEvents[idx];
                if (btn.classList.contains('load-btn')) {
                    // Laden ändert die Überschrift nicht! Nur den Zwischenspeicher (pendingTitle)
                    mode = ev.mode; 
                    selectedDateTime = ev.selectedDateTime;
                    days = ev.days; hours = ev.hours; minutes = ev.minutes; seconds = ev.seconds;
                    pendingTitle = ev.name; 
                    hasManualChanges = false; 
                    
                    if(mode === 'targetDate') document.getElementById('datetime-input').value = selectedDateTime;
                    else {
                        document.getElementById('input-days').value = formatInputVal(days);
                        document.getElementById('input-hours').value = formatInputVal(hours);
                        document.getElementById('input-minutes').value = formatInputVal(minutes);
                        document.getElementById('input-seconds').value = formatInputVal(seconds);
                    }
                    updateUI();
                } else if (btn.classList.contains('delete-btn')) {
                    savedEvents.splice(idx, 1); saveEventsToStorage(); updateUI();
                } else if (btn.classList.contains('edit-btn')) {
                    editingEventIndex = idx;
                    eventNameInput.value = ev.name;
                    if (ev.mode === 'targetDate') {
                        modalTimeInputs.innerHTML = `<label class="block text-xs font-medium text-slate-500 mb-1">Zielzeit</label>
                        <input type="datetime-local" id="modal-datetime-input" class="w-full p-2 border border-gray-200 rounded-lg mb-2" value="${ev.selectedDateTime}">`;
                    } else {
                        modalTimeInputs.innerHTML = `<label class="block text-xs font-medium text-slate-500 mb-1">Dauer (T:H:M:S)</label>
                        <div class="flex space-x-1 mb-2">
                            <input type="number" id="modal-input-days" class="w-1/4 p-1 border rounded" placeholder="T" value="${formatInputVal(ev.days)}">
                            <input type="number" id="modal-input-hours" class="w-1/4 p-1 border rounded" placeholder="H" value="${formatInputVal(ev.hours)}">
                            <input type="number" id="modal-input-minutes" class="w-1/4 p-1 border rounded" placeholder="M" value="${formatInputVal(ev.minutes)}">
                            <input type="number" id="modal-input-seconds" class="w-1/4 p-1 border rounded" placeholder="S" value="${formatInputVal(ev.seconds)}">
                        </div>`;
                    }
                    saveModal.classList.remove('hidden');
                }
            });

            const stored = localStorage.getItem('savedCountdownEvents');
            if (stored) savedEvents = JSON.parse(stored);
            createInputs();
            const appState = localStorage.getItem('countdownAppState');
            if (appState) {
                const s = JSON.parse(appState);
                mode = s.mode; selectedDateTime = s.selectedDateTime || setNowAsDateTime();
                isMuted = s.isMuted; days = s.days; hours = s.hours; minutes = s.minutes; seconds = s.seconds;
                currentTitle = s.currentTitle || '';
                pendingTitle = s.pendingTitle || '';
                hasManualChanges = s.hasManualChanges || false;
                if(s.isCountingDown && s.targetDate && new Date(s.targetDate) > new Date()) {
                    targetDate = s.targetDate; startCountdown(true);
                }
            } else { selectedDateTime = setNowAsDateTime(); }
            
            if(document.getElementById('datetime-input')) document.getElementById('datetime-input').value = selectedDateTime;
            ['days', 'hours', 'minutes', 'seconds'].forEach(k => {
                const el = document.getElementById(`input-${k}`);
                if(el) {
                    const val = (k==='days'?days:(k==='hours'?hours:(k==='minutes'?minutes:seconds)));
                    el.value = formatInputVal(val);
                }
            });
            updateUI();
        });
    </script>
</body>
</html>
